<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>sbotto.io - Bacheca P2P</title>
<style>
body{
  font-family:"Arial Rounded MT Bold", Arial, sans-serif;
  background:#f3efe6; margin:0; padding:20px;
}
.container{max-width:1200px; margin:auto; text-align:center;}
h1{margin-bottom:10px;}
.intro {
  max-width: 800px;
  margin: 10px auto 20px auto;
  padding: 15px 20px;
  border-radius: 8px;
  background: #fff3cd;
  color: #856404;
  font-weight: bold;
  font-size: 15px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  position: relative;
}
.info-icon { margin-left: 10px; cursor: pointer; font-size: 18px; }

/* Popup regolamento */
#regolamentoBox {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  max-width: 500px;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  z-index: 3000;
  text-align: left;
  line-height: 1.5;
}
#regolamentoBox .close {
  position: absolute;
  top: 10px; right: 15px;
  cursor: pointer; font-size: 20px;
}
#overlay {
  display: none; position: fixed; top:0; left:0;
  width:100%; height:100%; background: rgba(0,0,0,0.5);
  z-index: 2000;
}

textarea{
  width:100%; height:80px; padding:10px; border-radius:5px;
  border:1px solid #ccc; resize:none; font-size:14px;
}
.controls{
  margin:10px 0; display:flex; flex-wrap:wrap;
  justify-content:center; gap:15px;
}
.controls label{font-weight:bold; margin-right:5px;}
button{
  margin-top:10px; padding:10px 20px; border:none; border-radius:5px;
  background:#ff7043; color:#fff; cursor:pointer; font-weight:bold;
}
button:hover{background:#f4511e;}

#board{
  position:relative; width:100%; min-height:800px;
  background:#fafafa; border:2px dashed #ccc; overflow:hidden;
}

/* Post-it base */
.note{
  width:130px; height:170px;
  padding:10px;
  border-radius:2px;
  position:absolute; overflow:hidden;
  cursor:grab;
  display:flex; flex-direction:column; justify-content:flex-start; align-items:center;
  box-shadow:-3px 3px 6px rgba(0,0,0,.25), inset 0 0 30px rgba(255,255,255,.3);
  transition: left 0.5s ease, top 0.5s ease, transform 0.3s ease, box-shadow .15s;
  touch-action:none;
}
.note:active{cursor:grabbing;}
.note:hover{ box-shadow:-4px 4px 8px rgba(0,0,0,.35); }
body.dragging{ user-select:none; }

/* Angolo sollevato */
.note::after{
  content:""; position:absolute; right:0; bottom:0; width:40px; height:40px;
  background:linear-gradient(135deg, rgba(0,0,0,.25), transparent 70%);
  clip-path:polygon(100% 0, 0 100%, 100% 100%); pointer-events:none;
}

/* Contenuti post-it */
.note .sticker{
  width:90px; height:90px; object-fit:contain;
  margin-top:4px; margin-bottom:4px;
  /* bordo bianco tipo adesivo: viene dal PNG, qui solo leggero glow */
  filter: drop-shadow(0 1px 0 rgba(0,0,0,.15));
}
.note .text{
  font-size:13px; font-weight:bold; line-height:1.3; text-align:center;
  margin-top:6px; word-wrap:break-word;
}
.note small{ font-size:10px; color:#444; }

/* Peso immagine */
.note .imgkb {
  font-size:10px;
  color:#555;
  margin-top:4px;
  opacity:0.8;
}

/* icona elimina */
.note .delete{
  position:absolute; top:6px; right:8px; cursor:pointer;
  font-weight:bold; font-size:14px; display:none;
}
.note:hover .delete{ display:block; }

/* Pin rosso */
.note::before{
  content:""; width:12px; height:12px;
  background:radial-gradient(circle at 30% 30%, #ff5252, #c62828);
  border-radius:50%; position:absolute; top:6px; left:calc(50% - 6px);
  box-shadow:0 2px 5px rgba(0,0,0,.3);
}

/* Colori classici */
.yellow{background:linear-gradient(135deg,#fff59d,#fdd835);}
.blue  {background:linear-gradient(135deg,#90caf9,#42a5f5);}
.green {background:linear-gradient(135deg,#a5d6a7,#66bb6a);}
.pink  {background:linear-gradient(135deg,#f48fb1,#ec407a);}
.orange{background:linear-gradient(135deg,#ffcc80,#fb8c00);}
.black {background:linear-gradient(135deg,#000,#333); color:#fff;}
.red    {background:linear-gradient(135deg,#ff8a80,#e53935); color:#fff;}
.lilla  {background:linear-gradient(135deg,#ce93d8,#8e24aa); color:#fff;}
.fucsia,.fuxsia {background:linear-gradient(135deg,#f06292,#ad1457); color:#fff;}
.ghost {
  background: rgba(255, 255, 255, 0.05);
  color: rgba(0,0,0,0.3);
  border: 1px dashed rgba(0,0,0,0.15);
  backdrop-filter: blur(2px);
  box-shadow: none;
}
.madama {
  background:linear-gradient(135deg,#ff1744,#b71c1c);
  color:#fff;
  animation: lampeggio 0.8s infinite alternate;
}
@keyframes lampeggio {
  from { box-shadow:0 0 5px #ff1744, 0 0 10px #ff1744; }
  to   { box-shadow:0 0 20px #ff1744, 0 0 40px #ff1744; }
}

/* Zona busta (presente ma non obbligatoria) */
#shareZone {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 60px;
  background: url('https://upload.wikimedia.org/wikipedia/commons/4/4e/Envelope_font_awesome.svg') no-repeat center/contain;
  opacity: 0.6;
  transition: transform 0.2s, opacity 0.2s;
  z-index: 2000;
}
#shareZone.active { opacity: 1; transform: scale(1.1); }

/* Contatore */
#counterBox {
  margin-top: 10px;
  font-size: 14px;
  color: #333;
  font-weight: bold;
}

/* Barra sticker emozionali */
#stickersBar{
  display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
}
.sticker-btn{
  width:44px; height:44px; border-radius:10px; border:2px solid #eee;
  background:#fff; cursor:pointer; padding:4px;
  display:flex; align-items:center; justify-content:center;
  transition: transform .12s, box-shadow .12s, border-color .12s;
}
.sticker-btn img{ max-width:100%; max-height:100%; }
.sticker-btn:hover{ transform: translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.15); }
.sticker-btn.active{ border-color:#ff7043; box-shadow:0 0 0 3px rgba(255,112,67,.2); }
.sticker-hint{ font-size:12px; color:#666; margin-top:-6px; }
</style>
</head>
<body>
  <div class="container">
    <h1>üìå Sbotto un Post-it</h1>

    <div class="intro">
       ‚ö° Se pensi di muovere un post-it di nascosto‚Ä¶ buona fortuna üëÄ
       <span class="info-icon" onclick="toggleRegolamento()">‚ÑπÔ∏è</span>
    </div>

    <textarea id="noteInput" placeholder="Scrivi qui il tuo post-it (max 70 caratteri)..."></textarea>

    <div class="controls">
      <div>
        <label>Colore Post-it:</label>
        <select id="colorSelect">
          <option value="yellow">Giallo</option>
          <option value="blue">Blu</option>
          <option value="green">Verde</option>
          <option value="pink">Rosa</option>
          <option value="orange">Arancione</option>
        </select>
      </div>
      <div>
        <label>Colore Testo:</label>
        <select id="textColorSelect">
          <option value="#000000">Nero</option>
          <option value="#1e88e5">Blu</option>
          <option value="#d32f2f">Rosso</option>
          <option value="#388e3c">Verde</option>
          <option value="#8e24aa">Viola</option>
          <option value="#ffffff">Bianco</option>
        </select>
      </div>
      <div>
        <label>Sticker fotografico:</label>
        <input type="file" id="imageInput" accept="image/*">
      </div>
    </div>

    <!-- üé≠ STICKER EMOZIONALI (alternativi alla foto) -->
    <div style="margin-top:10px;">
      <div class="sticker-hint">Scegli uno sticker emozionale (oppure carica una foto):</div>
      <div id="stickersBar">
        <!-- i src puntano a /public/stickers/...  -->
        <button class="sticker-btn" data-sticker="happy.png"      title="Felice"><img src="stickers/happy.png"      alt="happy"></button>
        <button class="sticker-btn" data-sticker="sad.png"        title="Triste"><img src="stickers/sad.png"        alt="sad"></button>
        <button class="sticker-btn" data-sticker="angry.png"      title="Arrabbiato"><img src="stickers/angry.png"      alt="angry"></button>
        <button class="sticker-btn" data-sticker="surprised.png"  title="Sorpreso"><img src="stickers/surprised.png"  alt="surprised"></button>
        <button class="sticker-btn" data-sticker="scared.png"     title="Impaurito"><img src="stickers/scared.png"     alt="scared"></button>
        <button class="sticker-btn" data-sticker="relaxed.png"    title="Rilassato"><img src="stickers/relaxed.png"    alt="relaxed"></button>
      </div>
    </div>
   
    <button onclick="aggiungiNota()">Pubblica Post-it</button>
    <div id="counterBox">üìù Totale post-it: 0</div>
    <div id="board"></div>
  </div>

  <!-- Overlay + Box regolamento -->
  <div id="overlay" onclick="toggleRegolamento()"></div>
  <div id="regolamentoBox">
    <div class="close" onclick="toggleRegolamento()">√ó</div>
    <h2>üëã Benvenuto su sbotto.io</h2>
    <p>Bacheca anonima di post-it collaborativi.<br>Sfogati o lancia idee in tempo reale.</p>
    <hr>
    <h2>‚ú® In Diretta</h2>
    <p>Ogni post-it che compare qui √® stato scritto da qualcuno, da qualche parte, nello stesso momento.</p>
    <hr>
    <h2>üìú Regole</h2>
    <ul>
      <li>‚úçÔ∏è Messaggi brevi (max 70 caratteri).</li>
      <li>üö´ No spam o insulti.</li>
      <li>üëª Alcuni post-it speciali non si cancellano.</li>
      <li>ü§ù Rispetta gli altri e divertiti.</li>
    </ul>
  </div>

<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ‚úÖ Connetti al tuo nodo
const gun = Gun({
  peers: ["https://sbotto-server.onrender.com/gun"]
});
const notesDB = gun.get("p2p-postit");
const counterDB = gun.get("p2p-postit-counter");

let store = {};
let drag = null;
let selectedSticker = null; // es: "happy.png"

// Gestione barra sticker (alternativi alla foto)
const stickersBar = document.getElementById('stickersBar');
const imageInput = document.getElementById('imageInput');

stickersBar.addEventListener('click', (e)=>{
  const btn = e.target.closest('.sticker-btn');
  if(!btn) return;
  // toggle selezione
  if(btn.classList.contains('active')){
    btn.classList.remove('active');
    selectedSticker = null;
    // riabilita foto
    imageInput.disabled = false;
  } else {
    // deseleziona tutti
    document.querySelectorAll('.sticker-btn.active').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedSticker = btn.dataset.sticker; // nome file
    // disabilita foto
    imageInput.value = "";
    imageInput.disabled = true;
  }
});

// Se l'utente sceglie una foto, disabilita gli sticker
imageInput.addEventListener('change', ()=>{
  if(imageInput.files && imageInput.files[0]){
    selectedSticker = null;
    document.querySelectorAll('.sticker-btn.active').forEach(b=>b.classList.remove('active'));
  }
});

// Toggle regolamento
function toggleRegolamento(){
  const box = document.getElementById("regolamentoBox");
  const overlay = document.getElementById("overlay");
  const visible = box.style.display === "block";
  box.style.display = visible ? "none" : "block";
  overlay.style.display = visible ? "none" : "block";
}

// Calcola peso immagine
function dataUrlBytes(dataUrl){
  const base64 = dataUrl.split(',')[1] || "";
  const len = base64.length;
  const padding = (base64.endsWith("==") ? 2 : (base64.endsWith("=") ? 1 : 0));
  return Math.max(0, Math.floor(len * 3 / 4) - padding);
}

// Aggiungi nota
function aggiungiNota(){
  let text = document.getElementById("noteInput").value.trim();
  if(!text) return;
  if(text.length > 70) text = text.substring(0,67)+"...";
  const board = document.getElementById("board");
  const maxX = Math.max(0, board.clientWidth-150);
  const maxY = Math.max(0, board.clientHeight-170);

  let note = {
    id: Math.random().toString(36).substr(2, 9),
    text, date: Date.now(),
    x: Math.floor(Math.random()*maxX),
    y: Math.floor(Math.random()*maxY),
    rot: (Math.random()*10 - 5).toFixed(2)
  };

  const special = parseSpecial(text);
  if(special){ Object.assign(note, special); }
  else {
    note.color = document.getElementById("colorSelect").value;
    note.textColor = document.getElementById("textColorSelect").value;
  }

  // Se √® stato selezionato uno sticker emozionale, lo aggiungiamo e blocchiamo la foto
  if(selectedSticker){
    note.sticker = "stickers/" + selectedSticker; // salviamo il path
    note.image = null;
    note.imageKB = null;
    // NOTA: sticker non modificabile dopo la pubblicazione (nessun campo UI per cambiarlo)
    notesDB.get(note.id).put(note);
  } else {
    // Altrimenti gestiamo la foto (se presente)
    const file = imageInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const maxSize = 150;
          let width = img.width;
          let height = img.height;
          if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
          else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
          canvas.width = Math.max(1, Math.round(width));
          canvas.height = Math.max(1, Math.round(height));
          const ctx = canvas.getContext("2d");
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = "high";
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL("image/webp", 0.7);
          note.image = dataUrl;
          note.imageKB = Math.max(1, Math.round(dataUrlBytes(dataUrl)/1024));
          notesDB.get(note.id).put(note);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    } else {
      notesDB.get(note.id).put(note);
    }
  }

  // incrementa contatore
  counterDB.get("total").once(val=>{
    counterDB.get("total").put((val||0) + 1);
  });

  // reset UI
  document.getElementById("noteInput").value="";
  imageInput.value = "";
  imageInput.disabled = false;
  selectedSticker = null;
  document.querySelectorAll('.sticker-btn.active').forEach(b=>b.classList.remove('active'));
}

// Rileva comandi speciali
function parseSpecial(input){
  const m = input.match(/^\s*#([a-z√†√®√©√¨√≤√≥√π]+)\b/i);
  if(!m) return null;
  const tag = m[1].toLowerCase();
  const rest = input.replace(/^\s*#[^\s]+\s*/,'').trim();
  if(tag === 'mod')    return { color:'black',  textColor:'#fff', text:rest };
  if(tag === 'ghost')  return { color:'ghost',  textColor:'rgba(0,0,0,0.3)', text:rest };
  if(tag === 'madama') return { color:'madama', textColor:'#fff', text:rest };
  if(tag === 'red' || tag === 'rosso')   return { color:'red',   textColor:'#fff', text:rest };
  if(tag === 'lilla')  return { color:'lilla',  textColor:'#fff', text:rest };
  if(tag === 'fucsia' || tag === 'fuxsia') return { color:'fucsia', textColor:'#fff', text:rest };
  return null;
}

// Elimina nota
function eliminaNota(id){
  if(!confirm("Vuoi eliminare questo post-it?")) return;
  notesDB.get(id).put({deleted:true});
}

// Rendering
function render(){
  const board = document.getElementById("board");
  board.innerHTML="";
  Object.values(store).forEach(n=>{
    if(!n || n.deleted) return;

    const div = document.createElement("div");
    div.id = "note_"+n.id;
    div.className = `note ${n.color}`;
    div.style.color = n.textColor || "#000";
    div.style.left = (n.x||0) + "px";
    div.style.top  = (n.y||0) + "px";
    div.style.transform = `rotate(${n.rot}deg)`;

    let deleteBtn = "";
    if(!["black","ghost","madama","red","lilla","fucsia"].includes(n.color)){
      deleteBtn = `<div class="delete" onclick="event.stopPropagation(); eliminaNota('${n.id}')">√ó</div>`;
    }

    // Sticker emozionale (se presente) ha priorit√† sulla foto
    const stickerTag = n.sticker ? `<img class="sticker" src="${n.sticker}" alt="sticker">` : "";
    const imgTag = (!n.sticker && n.image) ? `<img src="${n.image}" style="max-width:90px; max-height:90px; border-radius:8px; margin-top:5px;">` : "";
    const kb = (n.imageKB || (n.image ? Math.round(dataUrlBytes(n.image)/1024) : null));
    const kbTag = (!n.sticker && n.image) ? `<div class="imgkb">~${kb} KB</div>` : "";

    div.innerHTML = `
      ${deleteBtn}
      ${stickerTag}
      ${imgTag}
      ${kbTag}
      <div class="text">${n.text || ""}</div>
      <small>${new Date(n.date).toLocaleString()}</small>
    `;

    // Drag start
    div.addEventListener("pointerdown",(e)=>{
      if(e.target.classList.contains("delete")) return;
      const elRect = div.getBoundingClientRect();
      drag = {
        id: n.id, el: div,
        offsetX: e.clientX - elRect.left,
        offsetY: e.clientY - elRect.top
      };
      div.style.transition = "none";
      div.style.zIndex = 9999;
      document.body.classList.add("dragging");
      if(div.setPointerCapture) { try{ div.setPointerCapture(e.pointerId);}catch(_){ } }
      e.preventDefault();
    });

    board.appendChild(div);
  });
}

// Dragging globale
function pointerMove(e){
  if(!drag) return;
  e.preventDefault();
  const board = document.getElementById("board");
  const b = board.getBoundingClientRect();
  const el = drag.el;
  let x = e.clientX - b.left - drag.offsetX;
  let y = e.clientY - b.top  - drag.offsetY;
  const maxX = board.clientWidth  - el.offsetWidth;
  const maxY = board.clientHeight - el.offsetHeight;
  x = Math.max(0, Math.min(x, maxX));
  y = Math.max(0, Math.min(y, maxY));
  el.style.left = x + "px";
  el.style.top  = y + "px";
}
function pointerUp(){
  if(!drag) return;
  const { id, el } = drag;
  const n = store[id];
  if(n){
    n.x = parseInt(el.style.left)||0;
    n.y = parseInt(el.style.top)||0;
    notesDB.get(id).put({ x:n.x, y:n.y });
  }
  el.style.transition = "left 0.5s ease, top 0.5s ease, transform 0.3s ease, box-shadow .15s";
  document.body.classList.remove("dragging");
  drag = null;
}
document.addEventListener("pointermove", pointerMove, {passive:false});
document.addEventListener("pointerup", pointerUp);

// Ascolta database
notesDB.map().on((n,id)=>{
  if(!n || !n.id || n.deleted){ delete store[id]; }
  else { store[id]=Object.assign(store[id]||{}, n); }
  render();
});

// Contatore globale
counterDB.get("total").on(val=>{
  document.getElementById("counterBox").textContent = "üìù Totale post-it: " + (val||0);
});

// ü´Ä Heartbeat: mantiene vivo il nodo e aiuta Safari
setInterval(()=>{
  notesDB.get("heartbeat").put({ t: Date.now() });
}, 30000);
</script>
</body>
</html>
